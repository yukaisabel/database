<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>wh4t i5 g01ng 0n!?!?!?!?!??!</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script src="offlineworld.js"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
            overflow: auto;
            background-color: white;
        }

        #sentenceDisplay {
            font-size: 18px;
            line-height: 1.6;
            width: calc(100% - 120px);
            white-space: pre-wrap;
            word-wrap: break-word;
            padding-right: 20px;
            position: relative;
        }

        #cursor {
            position: absolute;
            width: 2px;
            height: 20px;
            background-color: black;
            animation: blink 1s infinite;
            transition: all 0.1s ease;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        #colorLegend {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
            width: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .color-filter {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
            cursor: pointer;
            width: 100%;
        }

        /* change color button */
        .color-sample {
            width: 100px;
            height: 20px;
            border: 2px solid transparent;
        }

        .color-sample.active {
            border-color: black;
        }

        #displayAllBtn {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            padding: 5px;
            margin-bottom: 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.2s;
            font-family: Helvetica, Arial, sans-serif;
            width: 100%;
        }

        #displayAllBtn:hover {
            background-color: #e0e0e0;
        }

        .offlineposition {
            background: white;
            position: absolute;
            top: 0px;
            left: 0px;
            padding: 20px;
            z-index: 10000;
        }
    </style>
</head>

<body>
    <!-- <div id="online-world"> -->
    <div id="sentenceDisplay"></div>
    <div id="colorLegend">
        <div id="displayAllBtn">Show All</div>
    </div>
    <!-- </div> -->
    <div id="offline-world">
        <div class="offlineposition">
            <h1>hi</h1>
            <p style="line-height: 1">for extroverts i think its hard to understand how overwhelming it is to be in a
                large group of people , when u have something to say but u cant ,</p>
            <p>wanting to rehearse ur lines b4 speaking , being afraid of making faux pas , , , , ,,,,</p>
            <p>but at the same time</p>
            <p>i like observing in the background , bc u can laugh when u think smth is funny but no one expects u to
                when it isnt</p>
            <p>most of all u realize how much ppl dont listen and they talk talk talk talk talk talk talk talk talk talk
                talk talk talk talk talk talk talk talk talk talk talk talk talk talk talk talk talk talk talk talk talk
                talk talk talk talk talk talk talk talk talk talk talk talk talk talk talk talk talk talk talk talk talk
                talk talk talk talk talk talk talk talk talk talk talk</p>
            <p>there rly isnt any rush to get those words out , well i guess w humor time is of the essence</p>
            <p>how does it feel to get interrupted ? <br> how does it feel when u can only get a word out before ur time
                is cut short ? <br> how can we overcome this overlapping of words, of topics, of voices ?</p>
            <p>i wish we can use our ears to filter people</p>
            <p>and focus on one person at a time</p>
            <p>like this website . . . . . . ?</p>
            <p>i guess if ur here rn u r probably stranded somewhere... </p>
            <p>alone...</p>
            <p>nothing but ur thoughts...</p>
            <p>..,,,,;';;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ppp,,,,,,,,,,,,,,,........................................................................................../'
            </p>
            <p>sorry that was me trying to clean some gunk off my keyboard</p>
            <p>anyways here's the lyrics to john cale's "paris 1919"</p>
            <p>She makes me so unsure of myself <br>
                Standing there but never ever talking sense <br>
                Just a visitor you see <br>
                So much wanting to be seen <br>
                She'd open up the doors and vaguely carry us away <br>
                It's the customary thing to say or do <br>
                To a disappointed proud man in his grief <br>
                And on Fridays she'd be there <br>
                But on Mondays not at all <br>
                Just casually appearing from the clock across the hall <br>
                You're a ghost, la la la la la la la la la <br>
                You're a ghost, la la la la la la la la la <br>
                I'm the church and I've come <br>
                To claim you with my iron drum <br>
                La la la la la la <br>
                The Continent's just fallen in disgrace <br>
                William, William, William Rogers put it in its place <br>
                Blood and tears from old Japan <br>
                Caravans and lots of jam <br>
                And maids of honor singing, crying, singing tediously <br>
                You're a ghost, la la la la la la la la la <br>
                Yes, you're a ghost, la la la la la la la la la <br>
                I'm the bishop and I've come <br>
                To claim you with my iron drum <br>
                La la la la la la <br>
                Efficiency, efficiency, they say <br>
                Get to know the date and tell the time of day <br>
                As the crowds begin complaining <br>
                How the Beaujolais is raining <br>
                Down on darkened meetings on the Champs-Élysées <br>
                You're a ghost, la la la la la la la la la <br>
                You're a ghost, la la la la la la la la la <br>
                And I'm the church and I've come <br>
                To claim you with my iron drum <br>
                La la la la la la <br>
                You're a ghost, la la la la la la la la la <br>
                You're a ghost, la la la la la la la la la <br>
                I'm the church and I've come <br>
                To claim you with my iron drum <br>
                La la la la la la <br>
                You're a ghost, la la la la la la la la la <br>
                You're a ghost, la la la la la la la la la <br>
                I'm the church and I've come <br>
                To claim you with my iron drum <br>
                La la la la la la</p>
            <p>if you've never heard the song thennnn idk sorry <br> make it ur motivation to escape from ur offline
                hellhole and find some wifi or smth i guess</p>
            <p>and once u do u can paste this link: https://www.youtube.com/watch?v=q5YHqWqhFkU</p>
            <p>bye ! ＼＼\\٩( 'ω' )و //／／</p>
        </div>
    </div>


    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDtQPTctoNzWymLlfx7PnB2GiVjNDr7kO8",
            authDomain: "iml400-project-3-3f045.firebaseapp.com",
            databaseURL: "https://iml400-project-3-3f045-default-rtdb.firebaseio.com",
            projectId: "iml400-project-3-3f045",
            storageBucket: "iml400-project-3-3f045.firebasestorage.app",
            messagingSenderId: "139436198336",
            appId: "1:139436198336:web:78b8e39abfb6b019b72025",
            measurementId: "G-J9D77WYD2T"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Unique user identifier
        const currentUser = `user${Date.now()}`;

        // Improved color generation function
        function generateReadableColor() {
            const h = Math.floor(Math.random() * 360);
            const s = 70 + Math.floor(Math.random() * 30); // 70-100%
            const l = 40 + Math.floor(Math.random() * 20); // 40-60%
            return `hsl(${h}, ${s}%, ${l}%)`;
        }

        // Generate a unique color for this user
        const userColor = generateReadableColor();

        let currentWord = "";
        let currentFilter = null;
        let permanentWords = [];

        // Create cursor element
        const cursor = document.createElement('span');
        cursor.id = 'cursor';

        // Sentence display and color legend
        const sentenceDisplay = document.getElementById('sentenceDisplay');
        const colorLegend = document.getElementById('colorLegend');
        const displayAllBtn = document.getElementById('displayAllBtn');

        // Position cursor at the end of text
        function positionCursor() {
            // Remove existing cursor
            const existingCursor = document.getElementById('cursor');
            if (existingCursor) {
                existingCursor.remove();
            }

            // Create new cursor
            const cursor = document.createElement('span');
            cursor.id = 'cursor';

            // If there's a current word being typed
            if (currentWord) {
                const currentWordSpan = document.createElement('span');
                currentWordSpan.style.color = userColor;
                currentWordSpan.textContent = currentWord;
                sentenceDisplay.appendChild(currentWordSpan);
                sentenceDisplay.appendChild(cursor);
            } else {
                // If no word is being typed, position at the end of permanent words
                sentenceDisplay.appendChild(cursor);
            }
        }

        // Handle keypress events
        document.addEventListener('keydown', function (event) {
            // Ignore modifier keys
            if (event.key.length === 1 || event.key === 'Backspace' || event.key === ' ') {
                if (event.key === 'Backspace') {
                    // Remove last character
                    currentWord = currentWord.slice(0, -1);
                } else if (event.key === ' ') {
                    // Submit current word if not empty
                    if (currentWord.trim()) {
                        const wordToSubmit = currentWord.trim();
                        submitWord(wordToSubmit);
                        currentWord = "";
                    }
                } else {
                    // Add new character
                    currentWord += event.key;
                }

                // Render current typing state
                renderSentence();
            }
        });

        function submitWord(word) {
            // Create a unique key with timestamp to ensure no overwriting
            const newWordRef = db.ref("words").push();
            newWordRef.set({
                text: word,
                color: userColor,
                userId: currentUser,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        // Clear all previous words on page load
        db.ref("words").remove();

        // Render the collaborative sentence
        db.ref("words").orderByChild("timestamp").on("value", snapshot => {
            const wordsData = snapshot.val() || {};

            // Convert Firebase words to our permanent words array
            permanentWords = Object.values(wordsData).map(word => ({
                text: word.text,
                color: word.color,
                userId: word.userId
            }));

            // Update color legend
            updateColorLegend();

            // Render sentence
            renderSentence();
        });

        function updateColorLegend() {
            // Clear existing legend (keep display all button)
            const displayAllBtn = document.getElementById('displayAllBtn');
            colorLegend.innerHTML = '';
            colorLegend.appendChild(displayAllBtn);

            // Get unique colors
            const uniqueColors = [...new Set(permanentWords.map(word => word.color))];

            // Create color filter for each unique color
            uniqueColors.forEach(color => {
                const colorFilterWrapper = document.createElement('div');
                colorFilterWrapper.classList.add('color-filter');

                const colorSample = document.createElement('div');
                colorSample.classList.add('color-sample');
                colorSample.style.backgroundColor = color;

                // Add click event for filtering
                colorSample.addEventListener('click', () => {
                    // Toggle filter
                    currentFilter = currentFilter === color ? null : color;

                    // Update active state
                    document.querySelectorAll('.color-sample').forEach(el => {
                        el.classList.toggle('active', el.style.backgroundColor === color);
                    });

                    // Re-render sentence
                    renderSentence();
                });

                colorFilterWrapper.appendChild(colorSample);
                colorLegend.appendChild(colorFilterWrapper);
            });
        }

        // Display All button functionality
        displayAllBtn.addEventListener('click', () => {
            currentFilter = null;
            document.querySelectorAll('.color-sample').forEach(el => {
                el.classList.remove('active');
            });
            renderSentence();
        });

        function renderSentence() {
            // Clear display
            sentenceDisplay.innerHTML = '';

            // Render permanent words
            permanentWords.forEach(word => {
                const wordSpan = document.createElement("span");
                wordSpan.textContent = word.text + " ";

                // Apply color or make white based on filter
                if (!currentFilter || word.color === currentFilter) {
                    wordSpan.style.color = word.color;
                } else {
                    wordSpan.style.color = 'white';
                }

                sentenceDisplay.appendChild(wordSpan);
            });

            // Position cursor
            positionCursor();
        }

        // Clean up when user leaves
        window.addEventListener('beforeunload', function () {
            db.ref("words").orderByChild("userId").equalTo(currentUser).once("value", snapshot => {
                snapshot.forEach(childSnapshot => {
                    childSnapshot.ref.remove();
                });
            });
        });

        window.onkeydown = function (e) {
            return !(e.keyCode == 32);
        };
    </script>
</body>

</html>
